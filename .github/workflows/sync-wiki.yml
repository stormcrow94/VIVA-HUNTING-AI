name: Sync Wiki

on:
  push:
    branches:
      - main
    paths:
      - 'wiki.md'
      - 'README.md'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout wiki repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}.wiki
          path: wiki
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync wiki content
        run: |
          # Copy main wiki file
          cp wiki.md wiki/Home.md
          
          # Copy README as a separate page
          cp README.md wiki/Quick-Start.md
          
          # Create index page with navigation
          cat > wiki/_Sidebar.md << 'EOF'
          ## ðŸ“š NavegaÃ§Ã£o

          ### ðŸ  InÃ­cio
          - **[Home](Home)** - Wiki tÃ©cnica completa
          - **[Quick Start](Quick-Start)** - Guia rÃ¡pido

          ### ðŸŽ¯ Principais SeÃ§Ãµes
          - [Arquitetura](Home#2-arquitetura)
          - [Setup](Home#4-setup-detalhado)
          - [AutenticaÃ§Ã£o](Home#6-autenticaÃ§Ã£o-e-controle-de-acesso)
          - [IA & OpenAI](Home#7-orquestraÃ§Ã£o-ia-openai)
          - [FortiAnalyzer](Home#8-conector-fortianalyzer)
          
          ### ðŸ”§ OperaÃ§Ã£o
          - [Funcionalidades](Home#9-catÃ¡logo-de-funcionalidades)
          - [Testes](Home#10-testes-e-validaÃ§Ã£o)
          - [Troubleshooting](Home#11-operaÃ§Ã£o--troubleshooting)
          - [SeguranÃ§a](Home#12-seguranÃ§a-e-hardening)

          ### ðŸ“– Recursos AvanÃ§ados
          - [SeleÃ§Ã£o de ADOM](Home#15-seleÃ§Ã£o-de-adom-ponta-a-ponta)
          - [MemÃ³ria Contextual](Home#16-memÃ³ria-de-conversaÃ§Ã£o-e-follow-ups)
          - [GestÃ£o de UsuÃ¡rios](Home#17-gestÃ£o-de-usuÃ¡rios-e-painel-administrativo)
          - [Interface & UX](Home#18-interface-web-e-ux)
          - [MigraÃ§Ã£o OpenAI](Home#19-migraÃ§Ã£o-gemini--openai-e-histÃ³rico-de-versÃµes)

          ### ðŸš€ Roadmap
          - [PrÃ³ximos Passos](Home#13-roadmap-sugerido)
          - [Compatibilidade 7.4.8](Home#21-compatibilidade-com-fortianalyzer-748)

          ---

          **VersÃ£o**: 2.1.0  
          **Desenvolvido por**: stormcrow94  
          **Ãšltima atualizaÃ§Ã£o**: $(date +%Y-%m-%d)
          EOF

          # Create footer with version info
          cat > wiki/_Footer.md << 'EOF'
          ---
          
          ðŸ“Œ **VIVA-HUNTING-AI** | Chatbot inteligente para FortiAnalyzer  
          ðŸ”— [RepositÃ³rio](https://github.com/${{ github.repository }}) | â­ Desenvolvido com â¤ï¸ por stormcrow94
          EOF

      - name: Commit and push to wiki
        working-directory: wiki
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add .
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "ðŸ¤– Auto-sync from main repository wiki.md

          Synced from commit: ${{ github.sha }}
          Triggered by: ${{ github.actor }}
          Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          
          git push origin master

      - name: Summary
        run: |
          echo "âœ… Wiki sincronizada com sucesso!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Arquivos sincronizados:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`wiki.md\` â†’ \`Home.md\` (pÃ¡gina principal)" >> $GITHUB_STEP_SUMMARY
          echo "- \`README.md\` â†’ \`Quick-Start.md\`" >> $GITHUB_STEP_SUMMARY
          echo "- Sidebar e Footer atualizados" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Acesse a wiki:** https://github.com/${{ github.repository }}/wiki" >> $GITHUB_STEP_SUMMARY

